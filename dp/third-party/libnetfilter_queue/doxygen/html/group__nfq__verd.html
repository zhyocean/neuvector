<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>libnetfilter_queue: Verdict helpers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libnetfilter_queue
   &#160;<span id="projectnumber">1.0.5</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Verdict helpers</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gaaffdfe85f8d8f45fcba628e429c15fad"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nfq__verd.html#gaaffdfe85f8d8f45fcba628e429c15fad">nfq_nlmsg_verdict_put</a> (struct nlmsghdr *nlh, int id, int verdict)</td></tr>
<tr class="separator:gaaffdfe85f8d8f45fcba628e429c15fad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga923c9c04a5bcc8cf3e9a461c62aaf049"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nfq__verd.html#ga923c9c04a5bcc8cf3e9a461c62aaf049">nfq_nlmsg_verdict_put_mark</a> (struct nlmsghdr *nlh, uint32_t mark)</td></tr>
<tr class="separator:ga923c9c04a5bcc8cf3e9a461c62aaf049"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa0cb1c9609d5055ad5c701874ff06bbd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nfq__verd.html#gaa0cb1c9609d5055ad5c701874ff06bbd">nfq_nlmsg_verdict_put_pkt</a> (struct nlmsghdr *nlh, const void *pkt, uint32_t plen)</td></tr>
<tr class="separator:gaa0cb1c9609d5055ad5c701874ff06bbd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="gaaffdfe85f8d8f45fcba628e429c15fad"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nfq_nlmsg_verdict_put </td>
          <td>(</td>
          <td class="paramtype">struct nlmsghdr *&#160;</td>
          <td class="paramname"><em>nlh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>verdict</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>nfq_nlmsg_verdict_put - Put a verdict into a Netlink message </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nlh</td><td>Pointer to netlink message </td></tr>
    <tr><td class="paramname">id</td><td>ID assigned to packet by netfilter </td></tr>
    <tr><td class="paramname">verdict</td><td>verdict to return to netfilter (see <b>Verdicts</b> below) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section user"><dt>Verdicts</dt><dd><b>NF_DROP</b> Drop the packet. This is final. <br/>
 <b>NF_ACCEPT</b> Accept the packet. Processing of the current base chain and any called chains terminates, but the packet may still be processed by subsequently invoked base chains. <br/>
 <b>NF_STOP</b> Like <b>NF_ACCEPT</b>, but skip any further base chains using the current hook. <br/>
 <b>NF_REPEAT</b> Like <b>NF_ACCEPT</b>, but re-queue this packet to the current base chain. One way to prevent a re-queueing loop is to also set a packet mark using <a class="el" href="group__nfq__verd.html#ga923c9c04a5bcc8cf3e9a461c62aaf049">nfq_nlmsg_verdict_put_mark()</a> and have the program test for this mark in <code>attr</code>[NFQA_MARK]; or have the nefilter rules do this test. <br/>
 <b>NF_QUEUE_NR</b>(<em>new_queue</em>) Like <b>NF_ACCEPT</b>, but queue this packet to queue number <em>new_queue</em>. As with the command-line <b>queue</b> <b>num</b> verdict, if no process is listening to that queue then the packet is discarded; but again like with the command-line, one may OR in a flag to bypass <em>new_queue</em> if there is no listener, as in this snippet: <pre class="fragment">       nfq_nlmsg_verdict_put(nlh, id, NF_QUEUE_NR(new_queue) |
               NF_VERDICT_FLAG_QUEUE_BYPASS);
</pre></dd></dl>
<p>See <a class="el" href="nf-queue_8c_source.html">examples/nf-queue.c</a>, line <a href="nf-queue_8c_source.html#l00046" class="el">46</a> for an example of how to use this function in context. The calling sequence is <b>main</b> &ndash;&gt; <b>mnl_cb_run</b> &ndash;&gt; <b>queue_cb</b> &ndash;&gt; <b>nfq_send_verdict</b> &ndash;&gt; <b>nfq_nlmsg_verdict_put</b> (<b>cb</b> being short for <b>callback</b>). </p>

<p>Definition at line <a class="el" href="nlmsg_8c_source.html#l00072">72</a> of file <a class="el" href="nlmsg_8c_source.html">nlmsg.c</a>.</p>

</div>
</div>
<a class="anchor" id="ga923c9c04a5bcc8cf3e9a461c62aaf049"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nfq_nlmsg_verdict_put_mark </td>
          <td>(</td>
          <td class="paramtype">struct nlmsghdr *&#160;</td>
          <td class="paramname"><em>nlh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>mark</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>nfq_nlmsg_verdict_put_mark - Put a packet mark into a netlink message </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nlh</td><td>Pointer to netlink message </td></tr>
    <tr><td class="paramname">mark</td><td>Value of mark to put</td></tr>
  </table>
  </dd>
</dl>
<p>The mark becomes part of the packet's metadata, and may be tested by the <em>nft primary expression</em> <b>meta mark</b> </p>
<dl class="section see"><dt>See Also</dt><dd><b>nft</b>(1) </dd></dl>

<p>Definition at line <a class="el" href="nlmsg_8c_source.html#l00091">91</a> of file <a class="el" href="nlmsg_8c_source.html">nlmsg.c</a>.</p>

</div>
</div>
<a class="anchor" id="gaa0cb1c9609d5055ad5c701874ff06bbd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nfq_nlmsg_verdict_put_pkt </td>
          <td>(</td>
          <td class="paramtype">struct nlmsghdr *&#160;</td>
          <td class="paramname"><em>nlh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>pkt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>plen</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>nfq_nlmsg_verdict_put_pkt - Put replacement packet content into a netlink message </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nlh</td><td>Pointer to netlink message </td></tr>
    <tr><td class="paramname">pkt</td><td>Pointer to start of modified IP datagram </td></tr>
    <tr><td class="paramname">plen</td><td>Length of modified IP datagram</td></tr>
  </table>
  </dd>
</dl>
<p>There is only ever a need to return packet content if it has been modified. Usually one of the nfq_*_mangle_* functions does the modifying.</p>
<p>This code snippet uses nfq_udp_mangle_ipv4. See <a class="el" href="nf-queue_8c_source.html">nf-queue.c</a> for context: </p>
<pre class="fragment">// main calls queue_cb (line 64) to process an enqueued packet:
        // Extra variables
        uint8_t *payload, *rep_data;
        unsigned int match_offset, match_len, rep_len;

        // The next line was commented-out (with payload void*)
        payload = mnl_attr_get_payload(attr[NFQA_PAYLOAD]);
        // Copy data to a packet buffer (allow 255 bytes for mangling).
        pktb = pktb_alloc(AF_INET, payload, plen, 255);
        // (decide that this packet needs mangling)
        nfq_udp_mangle_ipv4(pktb, match_offset, match_len, rep_data, rep_len);
        // nfq_udp_mangle_ipv4 updates packet length, no need to track locally

        // Eventually nfq_send_verdict (line 39) gets called
        // The received packet may or may not have been modified.
        // Add this code before nfq_nlmsg_verdict_put call:
        if (pktb_mangled(pktb))
                nfq_nlmsg_verdict_put_pkt(nlh, pktb_data(pktb), pktb_len(pktb));
</pre> 
<p>Definition at line <a class="el" href="nlmsg_8c_source.html#l00130">130</a> of file <a class="el" href="nlmsg_8c_source.html">nlmsg.c</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Sep 13 2021 11:39:26 for libnetfilter_queue by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>

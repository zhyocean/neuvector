<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>libnetfilter_queue: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libnetfilter_queue
   &#160;<span id="projectnumber">1.0.5</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">libnetfilter_queue Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>libnetfilter_queue is a userspace library providing an API to packets that have been queued by the kernel packet filter. It is is part of a system that replaces the old ip_queue / libipq mechanism (withdrawn in kernel 3.5).</p>
<p>libnetfilter_queue homepage is: <a href="https://netfilter.org/projects/libnetfilter_queue/">https://netfilter.org/projects/libnetfilter_queue/</a></p>
<h1><a class="anchor" id="deps"></a>
Dependencies</h1>
<p>libnetfilter_queue requires libmnl, libnfnetlink and a kernel that includes the Netfilter NFQUEUE over NFNETLINK interface (i.e. 2.6.14 or later).</p>
<h1><a class="anchor" id="features"></a>
Main Features</h1>
<ul>
<li>receiving queued packets from the kernel nfnetlink_queue subsystem</li>
<li>issuing verdicts and possibly reinjecting altered packets to the kernel nfnetlink_queue subsystem</li>
</ul>
<p>The cinematic is the following: When an nft rule with action <b>queue</b> matches, the kernel terminates the current nft chain and enqueues the packet in a chained list. It then formats and sends an nfnetlink message containing the packet id and whatever information the userspace program configured to receive (packet data and/or metadata) via a socket to the userspace program.</p>
<p>The userspace program must issue a verdict advising the kernel to <b>accept</b> or <b>drop</b> the packet. Either verdict takes the packet off the queue: <b>drop</b> discards the packet while <b>accept</b> passes it on to the next chain. Userspace can also alter packet contents or metadata (e.g. packet mark, contrack mark). Verdict can be done in asynchronous manner, as the only needed information is the packet id.</p>
<p>When a queue is full, packets that should have been enqueued are dropped by kernel instead of being enqueued.</p>
<h1><a class="anchor" id="git"></a>
Git Tree</h1>
<p>The current development version of libnetfilter_queue can be accessed at <a href="https://git.netfilter.org/libnetfilter_queue">https://git.netfilter.org/libnetfilter_queue</a>.</p>
<h1><a class="anchor" id="privs"></a>
Privileges</h1>
<p>You need the CAP_NET_ADMIN capability in order to allow your application to receive from and to send packets to kernel-space.</p>
<h1><a class="anchor" id="using"></a>
Using libnetfilter_queue</h1>
<p>To write your own program using libnetfilter_queue, you should start by reading (or, if feasible, compiling and stepping through with <em>gdb</em>) <a class="el" href="nf-queue_8c_source.html">nf-queue.c</a> source file. Simple compile line: </p>
<pre class="fragment">gcc -g3 -ggdb -Wall -lmnl -lnetfilter_queue -o nf-queue nf-queue.c
</pre><p> The doxygen documentation <a class="el" href="group__LibrarySetup.html">LibrarySetup</a> is Deprecated and incompatible with non-deprecated functions. It is hoped to produce a corresponding non-deprecated (<em>Current</em>) topic soon.</p>
<p>Somewhat outdated but possibly providing some insight into libnetfilter_queue usage is the following article: <a href="https://home.regit.org/netfilter-en/using-nfqueue-and-libnetfilter_queue/">https://home.regit.org/netfilter-en/using-nfqueue-and-libnetfilter_queue/</a></p>
<h1><a class="anchor" id="errors"></a>
ENOBUFS errors in recv()</h1>
<p>recv() may return -1 and errno is set to ENOBUFS in case that your application is not fast enough to retrieve the packets from the kernel. In that case, you can increase the socket buffer size by means of nfnl_rcvbufsiz(). Although this delays the appearance of ENOBUFS errors, you may hit it again sooner or later. The next section provides some hints on how to obtain the best performance for your application.</p>
<h1><a class="anchor" id="perf"></a>
Performance</h1>
<p>To improve your libnetfilter_queue application in terms of performance, you may consider the following tweaks:</p>
<ul>
<li>increase the default socket buffer size by means of nfnl_rcvbufsiz().</li>
<li>set nice value of your process to -20 (maximum priority).</li>
<li>set the CPU affinity of your process to a spare core that is not used to handle NIC interruptions.</li>
<li>set NETLINK_NO_ENOBUFS socket option to avoid receiving ENOBUFS errors (requires Linux kernel &gt;= 2.6.30).</li>
<li>see &ndash;queue-balance option in NFQUEUE target for multi-threaded apps (it requires Linux kernel &gt;= 2.6.31).</li>
<li>consider using fail-open option see <a class="el" href="group__Queue.html#gab8672409480a68edab269130ac6742c4">nfq_set_queue_flags()</a> (it requires Linux kernel &gt;= 3.6)</li>
<li>increase queue max length with <a class="el" href="group__Queue.html#gabdf8f92fc12226a2e494f9932e3853e4">nfq_set_queue_maxlen()</a> to resist to packets burst </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Sep 13 2021 11:39:26 for libnetfilter_queue by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
